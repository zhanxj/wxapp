{php include wl_template('common/header');}
<style type="text/css">
#page-index .select-modal{position: fixed;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0, 0, 0, .3);display: none;z-index: 888;}
#page-index .index-nav{position: relative;z-index: 999;background-color: #fff;border-bottom: 1px solid #e7e7e7;}
#page-index .index-navbar{text-align:center;height: 50px;line-height: 50px;display: inline-block;}
#page-index .index-navbar span{font-size: .7rem;margin-top: -2px;}
#page-index .all-select{position: absolute;top: -260px;left: 0;z-index: 900;width: 100%;height: 300px;overflow: hidden;-webkit-transition: top .2s ease;transition: top .2s ease;}
#page-index .close-all-select{position: absolute;bottom: 0;left: 0;width: 100%;height: 38px;line-height: 36px;font-size: 22px;font-weight: 400;color: #999;text-align: center;background-color: #fff;font-family: sans-serif;}
#page-index .all-select-li{padding-left: 50px;list-style-type: none;height: 42px;line-height: 42px;opacity: 0;border-bottom: 1px solid #f2f2f2;}
#page-index #all-select-left{position: relative;padding: .3rem .75rem;top: 2px;width: 150%;height: 300px;color: #666;overflow-y: scroll;background-color: #fcfcfc;padding-bottom: 1.5rem;}
#page-index #all-select-right{position: relative;padding: .3rem 0;top: -100%;left: 160px;width: 80%;height: 300px;color: #777;overflow-y: scroll;display: none;border-bottom: 1px solid #fff;border-left: 1px solid #eee;background-image: url({URL_APP_RESOURCE}
image/select_bg.png);background-size: 90% auto;padding-bottom: 1.5rem;}
#page-index #all-select-left li{-webkit-transition: all .1s ease;transition: all .1s ease;}
#page-index #all-select-right li{-webkit-transition: all .1s ease;transition: all .1s ease;}
#page-index #all-type:before{content: "";position: absolute;top: 15px;left: 33.3333%;height: 20px;width: 1px;background-color: #e7e7e7;}
#page-index #all-city:before{content: "";position: absolute;top: 15px;left: 66.6666%;height: 20px;width: 1px;background-color: #e7e7e7;}
#page-index .icon-animate{padding-top: .1rem;font-size: 8px;color: #999;transition: all .3s linear;-webkit-transition: all .3s linear;}
#page-index .select-li-icon{font-size: .55rem;line-height: .5rem;text-align: center;color: #fff;background-color: #e6e6e6;padding: .05rem .2rem;margin-left: 2rem;margin-top: 1rem;border-radius: 3px;}
#page-index #all-select-right .all-select-li .select-li-icon{background-color: transparent;font-size: .6rem;color: #aaa;}
#page-index em{font-style: normal;}
#page-index .list-tag div{height: 1rem;}
#page-index .item-media img{width: 3.8rem;vertical-align: middle;}
.actives{position: relative;left: -0.1rem;margin-top: 0.2rem;}
.actives span {display: inline-block;font: inherit;color:#fff;font-size:0.6rem;width:0.8rem;height:0.8rem;line-height:0.8rem;margin-left:0.25rem;margin-right:0.25rem;border-radius:.1rem;text-align:center}
.actives .ka {background-color:#c8b39a;}
.actives .qiang {background-color:#FF6C6B;}
.actives .hui {background-color:#ff8400;}
.hideactive{display: none;}
.moreicon{position: absolute;top: 2.6rem;right: .3rem;display: inline-block;padding-left: 1rem;padding-right: .2rem;padding-top: 1rem;padding-bottom: 1rem;}
.list-container .item-link .item-inner{background-size: 0;padding-right: 0.5rem;}
</style>
<div class="page-group">
	<div class="page page-current" id="page-index">
		{php include wl_template('common/followbar');}
		{php include wl_template('common/footerbar');}
		<div class="row no-gutter index-nav navbar-fixed-top">
			<div class="col-33 index-navbar sherry-click" id="all-nearby" data-id="">
				<em>附近优先</em>
				<span class="icon iconfont icon-unfold icon-animate" id="all-nearby-icon"></span>
			</div>
			<div class="col-33 index-navbar sherry-click" id="all-city" data-id="">
				<em>全城</em>
				<span class="icon iconfont icon-unfold icon-animate" id="all-city-icon"></span>
			</div>
			<div class="col-33 index-navbar sherry-click" id="all-type" data-id="">{if $cname}{$cname}{else}<em>商户分类</em>{/if}
				<span class="icon iconfont icon-unfold icon-animate" id="all-type-icon"></span>
			</div>
		</div>
		<div class="select-modal"></div>
		<div class="all-select">
			<ul id="all-select-left"></ul>
			<ul id="all-select-right"></ul>
			<div class="close-all-select sherry-click">×</div>
		</div>
		<div class="content infinite-scroll-bottom infinite-scroll" style="margin-top: 50px;">
			<div class="list-block media-list" id="dataBox">
				<ul class="list-container"></ul>
			</div>
			<div class="infinite-scroll-preloader">
				<div class="weui-loadmore">
					<i class="weui-loading"></i>
					<span class="weui-loadmore__tips">正在加载</span>
				</div>
			</div>
		</div>
	</div>
</div>
<script id="storetemid" type="text/html">
	{{# for(var i = 0, len = d.length; i < len; i++){ }}
	<li>
		<a href="{{ d[i].url }}"  class="item-link item-content">
			<div class="item-media" style="width: 3.5rem;height: 1rem;">
				<img src="{{ d[i].logo }}" style='width: 3.5rem;height: 2.625rem;position: absolute;top: .75rem;'>
			</div>
			<div class="item-inner">
				<div class="item-title-row">
					<div class="item-title">{{ d[i].storename }}</div>
					<div class="item-after" style="color: #06C1AE;">{{ d[i].distance }}</div>
				</div>
				<div class="item-subtitle" style="font-size: .65rem;color: #929292;">{{ d[i].storehours }}</div>
				<div class="item-subtitle" style="font-size: .65rem;color: #929292;">{{ d[i].cate }}</div>
				{{# if(d[i].halfcard){ }}
				<div class="item-subtitle actives" style="font-size: .65rem;color: #929292;"><span class="ka">卡</span>{{ d[i].halfcard }}</div>
				{{# } }}
				{{# if(d[i].rush.length){ }}
				{{# for(var y = 0,len1 = d[i].rush.length; y < Math.min(d[i].rushnum,len1) ; y++){ }}
				<div class="item-subtitle actives" style="font-size: .65rem;color: #929292;"><span class="qiang">抢</span>{{ d[i].rush[y].name }}</div>
				{{# } }}
				{{# } }}
				{{# if(d[i].coupon.length){ }}
				{{# for(var w = 0,len2 = d[i].coupon.length; w < Math.min(d[i].couponnum,len2) ; w++){ }}
				<div class="item-subtitle actives" style="font-size: .65rem;color: #929292;"><span class="hui">券</span>{{ d[i].coupon[w].title }}</div>
				{{# } }}
				{{# } }}
			</div>
		</a>
	</li>
	{{# } }}
</script>
<script type="text/javascript">
	var loading = false,
		maxItems = 1000,
		itemsPerLoad = 10,
		nothing = false,
		lastIndex = 10,
		n = 0,
		pid = "",
		cid = "",
		distid = "",
		listData = [],
		page = 1,
		pagesize = 8,
		endmark = 1,
		t = null,
		tt = null;
	var map, geolocation;
	var longitude = 0,
		latitude = 0;
	//加载地图，调用浏览器定位服务
	map = new AMap.Map('container', {
		resizeEnable: true
	});
	map.plugin('AMap.Geolocation', function() {
		geolocation = new AMap.Geolocation({
			enableHighAccuracy: true, //是否使用高精度定位，默认:true
			timeout: 10000, //超过10秒后停止定位，默认：无穷大
			buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
			zoomToAccuracy: true, //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
			buttonPosition: 'RB'
		});
		map.addControl(geolocation);
		geolocation.getCurrentPosition();
		AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
		AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息
	});
	AMap.service('AMap.Geocoder', function() { //回调函数
			//实例化Geocoder
			geocoder = new AMap.Geocoder({
				city: "010" //城市，默认：“全国”
			});
		})
		//解析定位结果
	function onComplete(data) {
		latitude = data.position.getLat(); // 纬度，浮点数，范围为90 ~ -90
		longitude = data.position.getLng(); // 经度，浮点数，范围为180 ~ -180。
		var posturl = "{php echo app_url('store/merchant/getstore',array('cid'=>$cid,'pid'=>$pid,'keyword'=>$keyword))} "+ "&lng=" + longitude + "&lat=" + latitude;
		ajaxGetFn({
			url: posturl,
			fn: function(data) {
				listData = data;
			//	alert(JSON.stringify(data[0]['rush'].length));
				sessionStorage.setItem("demokey",JSON.stringify(data));
				var contentdata = data.slice(0,pagesize);
				addItems(itemsPerLoad, 0, contentdata);
			}
		})
	}
	//解析定位错误信息
	function onError(data) {
		$.alert('获取地理位置失败，重新获取！', function() {
			location.href = "{php echo app_url('dashboard/home')}";
		});
	}

	function ajaxGetFn(option) {
		$.ajax({
			type: "GET",
			url: option.url,
			async: true,
			success: function(data) {
				data = eval(data);
				option.fn(data);
			},
			error: function() {}
		});
	}

	function openSelectFn() {
		clearTimeout(t);
		$("#page-index .select-modal").css({
			"display": "block"
		})
		$("#page-index .all-select").css({
			"top": "40px"
		})
		$("#page-index #all-select-left li").css({
			"opacity": "0",
			"paddingLeft": "50px"
		})
		$("#page-index #all-select-right li").css({
			"opacity": "0",
			"paddingLeft": "50px"
		})
		$("#page-index #all-select-right").css({
			"display": "none"
		})
		setTimeout(function() {
			$("#page-index #all-select-left li").css({
				"opacity": "1",
				"paddingLeft": "8px"
			})
		}, 200);
	}

	function closeSelectFn() {
		resetSwitchIcon();
		$(".all-select").css({
			"top": "-260px"
		})
		$(".select-modal").css({
			"display": "none"
		})
		setTimeout(function() {
			$("#all-select-left li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right").css({
				"display": "none"
			})
		}, 200)
	}

	function resetLoadFn(data) {
		$('.infinite-scroll-preloader').css({
			"display": "block"
		});
		//重置加载数据的最初值                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		lastIndex = 10;
		//判断提示 “没有啦”
		nothing = false;
		$(".all-select").css({
			"top": "-260px"
		})
		$(".select-modal").css({
			"display": "none"
		})
		setTimeout(function() {
			$("#all-select-left li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right li").css({
				"opacity": "0",
				"paddingLeft": "50px"
			})
			$("#all-select-right").css({
				"display": "none"
			})
		}, 200)
		$("#page-index #loadingToast").css({
			"display": "block"
		});
	//	$("#page-index .infinite-scroll-bottom .list-container").html("");
		addItems(itemsPerLoad, 0, data);
	}

	function clickLeftAnimate() {
		clearTimeout(tt);
		$("#page-index #all-select-right li").css({
			"opacity": "0",
			"paddingLeft": "50px"
		})
		$("#page-index #all-select-right").css({
			"display": "block"
		})
		tt = setTimeout(function() {
			$("#page-index #all-select-right li").css({
				"opacity": "1",
				"paddingLeft": "8px"
			})
		}, 200)
	}

	function addItems(number, lastIndex, data) {
		var html = '';

		$('.infinite-scroll-preloader').css({
			"display": "none"
		});
		
		var gettpl = document.getElementById('storetemid').innerHTML;
		laytpl(gettpl).render(data, function(html) {
			$('.infinite-scroll-bottom .list-container').append(html);
			loading = false;
		});
		if(data.length == 0) {
			if(!nothing) {
				var nothing_html = "<div style='background-color: white;'>" +
					'<div class="weui-loadmore weui-loadmore_line"><span class="weui-loadmore__tips">暂无更多数据</span></div></div>';
				$('.infinite-scroll-bottom .list-container').append(nothing_html);
				endmark = 0;
				nothing = true;
			}
		}
		page++;
	}

	/*****************/
	/*点击元素背景变暗效果*/
	$(".sherry-click").on('touchstart', function() {
		$(this).css({
			"backgroundColor": "#e6e6e6"
		});
	})
	$(".sherry-click").on('touchend', function() {
		$(this).css({
			"backgroundColor": "#fff"
		});
	})

	function repeatLi(left_html, left_data, left, all) {
		left_html += "<li class='all-select-li' data-id=''><em>" + all + "</em><li/>";
		$("#page-index " + left).html("");
		for(var i = 0; i < left_data.length; i++) {
			//查询条件左边html代码
			left_html += "<li class='all-select-li' data-id=" + left_data[i].id + "><em>" + left_data[i].name + "</em><li/>"
		}
		left_html += "<li class='all-select-li-disable'><li/>"
		$("#page-index " + left).append(left_html);
	}

	function switchIcon(id) {
		$('#' + id).css({
			"webkitTransition": "all .3s linear",
			"transition": "all .3s linear"
		})
		setTimeout(function() {
			$('#' + id).css({
				"transform": "rotate(180deg)",
				"webkitTransform": "rotate(180deg)"
			}, 50)
		})
	}

	function switchIcon2(id) {
		$('#' + id).css({
			"webkitTransition": "all .3s linear",
			"transition": "all .3s linear",
			"transform": "rotate(180deg)",
			"webkitTransform": "rotate(180deg)"
		})
		setTimeout(function() {
			$('#' + id).css({
				"transform": "rotate(0deg)",
				"webkitTransform": "rotate(0deg)"
			}, 50)
		})
	}

	function resetSwitchIcon() {
		$('#all-type-icon').css({
			"transform": "rotate(0deg)",
			"webkitTransform": "rotate(0deg)"
		})
		$('#all-nearby-icon').css({
			"transform": "rotate(0deg)",
			"webkitTransform": "rotate(0deg)"
		})
		$('#all-city-icon').css({
			"transform": "rotate(0deg)",
			"webkitTransform": "rotate(0deg)"
		})
	}
	//以上为定义的全局函数 ， 下面是操作方法	

	$("#page-index #all-type").click(function() {
		resetSwitchIcon();
		nothing = false;
		//重置页面数
		page = 1;
		endmark = 1;
		ajaxGetFn({
			url: "{php echo app_url('store/merchant/getcategory')}",
			fn: function(left_data) {
				console.log(left_data);
				var left_html = '';
				switchIcon('all-type-icon');
				repeatLi(left_html, left_data, "#all-select-left", "全部分类");
				$("#page-index #all-select-left .all-select-li").click(function() {
						var type_name = $(this).children("em").text();
						var type_right_id = $(this).attr("data-id");
						//点击列表项高亮背景颜色
						$("#page-index #all-select-left .all-select-li").css({backgroundColor:"#fcfcfc"})
						$(this).css({backgroundColor:"#eee"})
						cid = $(this).attr("data-id");
						ajaxGetFn({
							url: "{php echo app_url('store/merchant/getcategory')}" + "pid=" + cid,
							fn: function(right_data) {
								var right_html = '';
								if (type_right_id=='') {
									repeatLi(right_html, [], "#all-select-right", "全部分类");
								}else{
									repeatLi(right_html, right_data, "#all-select-right", "全部 ("+type_name+")");
								}
								/*按条件加载数据*/
								$("#page-index #all-select-right .all-select-li").click(function() {
									$('.infinite-scroll-bottom .list-container').html("");
									var type_right_name = $(this).children("em").text();
									page = 1;
									type_right_id = $(this).attr("data-id");
									$("#all-type").attr("data-id", type_right_id);
									pid = $("#all-type").attr("data-id");
									distid = $("#all-city").attr("data-id");
									ajaxGetFn({
										url: "{php echo app_url('store/merchant/getstore')}" + "pid=" + pid +"&cid="+ cid  + "&distid=" + distid + "&page=" + page + "&lng=" + longitude + "&lat=" + latitude,
										fn: function(type_data) {
											listData = type_data;
											if(type_right_name != "全部") {
												$("#all-type").attr("data-id", type_right_id);
												$("#all-type").children("em").text(type_right_name);
											} else {
												$("#all-type").attr("data-id", type_right_id);
												$("#all-type").children("em").text(type_name);
											}
											switchIcon2('all-type-icon');
											sessionStorage.setItem("demokey",JSON.stringify(type_data));
											var contentdata = type_data.slice(0,pagesize);
											resetLoadFn(contentdata);
										}
									})
								})
								clickLeftAnimate();
							}
						})
					})
					//打开下拉选项
				openSelectFn();
			}
		})
	})
	var city_id = '';
	var city_name = '';
	//按城市查询
	$("#page-index #all-city").click(function() {
			resetSwitchIcon();
			nothing = false;
			page = 1;
			endmark = 1;
			ajaxGetFn({
				url: "{php echo app_url('store/merchant/getarea')}",
				fn: function(left_data) {
					var left_html = '';
					switchIcon('all-city-icon');
					repeatLi(left_html, left_data, "#all-select-left", "全城")
						/*按条件加载数据*/
					$("#page-index #all-select-left .all-select-li").click(function() {
						city_name = $(this).children("em").text();
						city_id = $(this).attr("data-id");
						$('.infinite-scroll-bottom .list-container').html("");
						$("#all-city").attr("data-id", city_id);
						pid = $("#all-type").attr("data-id");
						distid = $("#all-city").attr("data-id");
						ajaxGetFn({
							url: "{php echo app_url('store/merchant/getstore')}" + "pid=" + pid+"&cid="+ cid + "&distid=" + distid + "&page=" + page + "&lng=" + longitude + "&lat=" + latitude,
							fn: function(city_data) {
								listData = city_data;
								$("#all-city").children("em").text(city_name);
								switchIcon2('all-city-icon');
								sessionStorage.setItem("demokey",JSON.stringify(city_data));
								var contentdata = city_data.slice(0,pagesize);
								resetLoadFn(contentdata);
							}
						})
					})
					//打开下拉选项
					openSelectFn();
				}
			})

		})
		//按距离查询
	$("#page-index #all-nearby").click(function() {
		resetSwitchIcon();
		switchIcon('all-nearby-icon');
		var left_html = '';
		var nearby_data = []
		page = 1;
		endmark = 1;
		nothing = false;
		repeatLi(left_html, nearby_data, "#all-select-left", "附近优先");
		/*按条件加载数据*/
		$("#page-index #all-select-left .all-select-li").click(function() {
			var nearby_name = $(this).children("em").text();
			var nearby_id = $(this).attr("data-id");
			$("#all-nearby").attr("data-id", nearby_id);
			$('.infinite-scroll-bottom .list-container').html("");
			ajaxGetFn({
				url: "{php echo app_url('store/merchant/getstore')}" + "pid=" + pid +"&cid="+ cid  + "&distid=" + distid + "&page=" + page + "&lng=" + longitude + "&lat=" + latitude,
				fn: function(nearby_data) {
					listData = nearby_data;
					$("#all-nearby").children("em").text(nearby_name);
					switchIcon2('all-nearby-icon');
					sessionStorage.setItem("demokey",JSON.stringify(nearby_data));
					var contentdata = nearby_data.slice(0,pagesize);
					resetLoadFn(contentdata);
				}
			})
		})
		//打开下拉选项
		openSelectFn();
	})
	$(document).on('infinite', '.infinite-scroll-bottom', function() {
		if(loading) return;
		loading = true;
		if(endmark){
			$('.infinite-scroll-preloader').show();
			setTimeout(function() {
				var dt = JSON.parse(sessionStorage.getItem("demokey"));
				var xxx = dt.slice((page-1)*pagesize ,(page-1)*pagesize+pagesize);
				resetLoadFn(xxx);
			}, 800);
		}
	});
	
	function showactive(e){
		var status = $(e).attr('status');
		var id = $(e).attr('hideid');
		if(status == "hide"){
			$(e).attr('status','show');
			$('#h'+id).show();
		}else if(status == "show"){
			$(e).attr('status','hide');
			$('#h'+id).hide();
		}
	}
	//关闭条件查询
	$(".close-all-select").click(function() {
		closeSelectFn();
	})
	$(".select-modal").click(function() {
		closeSelectFn();
	})
	$.init();
</script>
{php include wl_template('common/footer');}