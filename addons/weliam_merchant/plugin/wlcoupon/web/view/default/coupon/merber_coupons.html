{php include wl_template('common/header');}
<style type='text/css'>
.trbody td{text-align: center;vertical-align:top;border-left:1px solid #ccc;border-bottom: 1px solid #ddd;}
.order-rank img{width:16px;height:16px;}
.js-remark,.js-admin-remark{word-break:break-all;overflow:hidden;background: #FDEEEE;color: #ED5050;padding: 5px 10px;}
td.goods-info{position:relative;padding-left:60px;}
.goods-info .img{position:absolute;top:50%;margin-top:-25px;background: url({IMAGE_LOADING}
) center center no-repeat;width:50px;height:50px;}
.goods-info span{white-space: nowrap;overflow: hidden;text-overflow: ellipsis;display: block;}
.status-text{cursor:pointer;}
.table>thead>tr>th, .table>tbody>tr>th, .table>tfoot>tr>th, .table>thead>tr>td, .table>tbody>tr>td, .table>tfoot>tr>td{border-top: 1px solid rgba(221, 221, 221, 0);}
.col-md-1{padding-right: 0px;}
.all-tips{margin-left: 65px;}
span.effect-time{font-size: 12px;display: block;font-weight: 500;}
.row.row-fix, .form-group.form-group-fix{margin-left: -15px;margin-right: -15px;width: 500px;}
button.btn.btn-default.daterange.daterange-date{float: left;margin-left: 234px;position: absolute;z-index: 100;}
#sel_child{z-index: 10;width: 200px;position: absolute;display: none;}
.show1{display: block;}
.hide1{display: none;}
.daterange-date{display: none;}
.sty{display: block;width: 100%;font-size: 13px;height: 46px;overflow: hidden;white-space: nowrap;line-height: 46px;text-overflow: ellipsis;text-align: center;}
.spe{display: inline-block;text-align: center;display: block;height: 33px;margin-left: -12px;padding-top: 0px;line-height: 33px;}
.table>thead>tr>td, .table>tbody>tr>td, .table>tfoot>tr>td{white-space: normal;}
span.ppp{text-align: center;display: inline-block;font-size: 14px;width: 100%;overflow: hidden;text-overflow: ellipsis;color: #e43;}
select#sel_parent{z-index: 1000;}
.nickname{margin-left: 94px;height: 34px;width: 200px;display: none;}
.col-xs-12.col-sm-6.col-md-6.col-lg-6{z-index: 9999;}
.start-time{font-size: 12px;}
.end-time{font-size: 12px;}
</style>
<div class="panel">
	    <div class="panel-body">
            <form action="" method="get" class="form-horizontal" role="form" id="form1">
               	<input type="hidden" name="c" value="site" />
	            <input type="hidden" name="a" value="entry" />
	            <input type="hidden" name="m" value="weliam_merchant" />
	            <input type="hidden" name="p" value="coupon" />
				<input type="hidden" name="ac" value="couponlist" />
				<input type="hidden" name="do" value="merbercoupon" />
                <div class="form-group">
                    <div class="col-md-2" id="double">
                        <!--<select name="keywordtype" class="form-control">
                        	<option value="">关键字类型</option>
                            <option value="1" {if $_GPC['keywordtype']==1}selected="selected"{/if}>优惠券类型</option>
                            <option value="2" {if $_GPC['keywordtype']==2}selected="selected"{/if}>优惠券状态</option>
                          <option value="3" {if $_GPC['keywordtype']==3}selected="selected"{/if}>优惠券XX</option>
                          
                        </select>-->
                        {php echo tpl_form_field_category_2level('sel',$sel1, $sel2, $_GPC['sel']['parentid'], $_GPC['sel']['childid']);}
                    </div>
                     <div class="col-md-2 ">
            			{if $_GPC['sel']['parentid']==0}
                    	   	<input type="text" name="keyword" value="{$_GPC['keyword']}" placeholder="请输入查询内容" class="nickname" style="display: block;" autocomplete="off" id="box1"/>
		                   	{else if $_GPC['sel']['parentid']==4 || $_GPC['sel']['parentid']==5}
		                   		<input type="text" name="keyword" value="{$_GPC['keyword']}" placeholder="请输入查询内容" class="nickname" style="display: block;" autocomplete="off"/>
		               	{/if}
                    </div>
                    <div class="col-md-2">
                    	    {php echo tpl_form_field_daterange('time_limit', array('starttime' => date('Y-m-d',$starttime), 'endtime' => date('Y-m-d', $endtime)));}
                    </div>
                    <div class="col-md-6 pull-right">
						<div class="input-group">
							
							<span class="input-group-addon" id="search" style="border: 1px solid #999;width: 90px;cursor: pointer;display: block;margin-left: 29rem; border-radius: 3px;" >搜索</span>
						</div>
					</div>
				</div>
            </form>
	    </div>
	</div>
	<script type="text/javascript">
		$("#search").click(function(){
			$('#form1')[0].submit();
		});
	</script>
	<!------------------------------------------------------>
<div class="order-list">
		<div class="panel-body table-responsive collapse in" id="order-template-item-4" style="padding: 0;">
			<table class="table table-bordered">
				<thead style="background-color: #FFFFFF;">
					<tr>
						<th style="width:50px;" class="text-center"><input type="checkbox" onclick="var ck = this.checked;$(':checkbox').each(function(){this.checked = ck});" />全选</th>
						<th style="width:50px">序号</th>
						<th style="width:190px;text-align:center;">优惠券标题</th>
						<th style="width:120px; text-align:center;">所属商家</th>
						<th style="width:80px; text-align:center;">类型</th>
						<th style="width:170px; text-align: center;">用户信息</th>
						<th style="width:80px; text-align:center;">优惠券价格</th>
						<th style="width:160px; text-align:center;">优惠券有效状态</th>
						<th style="width:50px; text-align: center;">操作</th>
					</tr>
				</thead>
				
			</table>
		</div>
		{loop $merber_coupon $y $item}
		<div class="panel panel-default">
			<!--	<div class="panel-heading clearfix" style="padding: 10px 15px;">
			<div class="pull-left">
					<span>使用须知: {$item['description']}</span>
				</div>
				<div class="pull-right">
						
						<a href="javascript:;" class="js-remove" order-id="{$item['id']}" >删除</a>
				</div>
				<!--<div class="pull-right">
					<span class="text-muted"></span>&nbsp;&nbsp;
				
					<a href="{php echo web_url('wlcoupon/couponlist/editCoupons', array('id' => $item['id']))}" class="" order-id="{$item['id']}"> 编辑</a> -
					<a href="javascript:;" class="js-remove" order-id="{$item['id']}" >删除</a>
				</div>-->
			<!--</div>-->
			<div class="panel-body table-responsive" style="padding: 0px;">
				<table class="table table-bordered">
					<tbody >
						<tr>
							<td class="text-center" style="width:50px; height: auto;">
								<center><input type="checkbox" name="checkbox[]" class="checkbox" value="{$item['id']}" /></center>
							</td>
							<td style="width: 50px;" ><center>{php echo $y+1}</center></td>
							<td class="goods-info line-feed" style="width:190px;padding-left: 10px;">
								<div class="img"><img width="50" height="50" class="oscrollLoading" data-url="{php echo tomedia($item['logo'])}" height="50" width="50" ></div>
								<div class="all-tips">
									<span class="">{$item['title']}</span>
								</div>
							</td>
							<td class="text-center" style="width:120px; font-family: "Arial","Microsoft YaHei","黑体","宋体",sans-serif ;">{$item['storename']}</td>
							<td class=" line-feed" style="width:80px;padding-left: 10px;">
								<div class="title" style="padding-left: 10px;position: relative;">
									<!--优惠券类型 1 折扣券 2代金券 3套餐券 4 团购券 5优惠券-->
									{if $item['type']==1}
										<span class="label label-white ">折扣券</span>
									{/if}
									{if $item['type']==2}
										<span class="label label-success ">代金券</span>
									{/if}
									{if $item['type']==3}
										<span class="label label-warning-light ">套餐券</span>
									{/if}
									{if $item['type']==4}
										<span class="label label-info ">团购券</span>
									{/if}
									{if $item['type']==5}
										<span class="label label-danger ">优惠券</span>
									{/if}
								</div>
							</td>
							<!---->
							<td class="goods-info line-feed" style="width:170px;padding-left: 10px;">
								<div class="img"><img width="50" height="50" class="oscrollLoading" data-url="{php echo tomedia($item['avatar'])}" height="50" width="50" ></div>
								<div class="all-tips">
									{$item['nickname']}
								</div>
								<div class="all-tips">
									{$item['mobile']}
								</div>
								
							</td>
							<!---->
							<td class="text-center" style="width:80px;">
								<!--{if $item['status']==0}<span class="label label-danger">未启用</span>{/if}
								{if $item['status']==1}<span class="label label-warning">已启用</span>{/if}							-->
								{if $item['orderno']}
									<span class="label label-info ">￥{$item['price']}</span>
								{else}
								<span class="label label-success ">免费</span>
								{/if}
								
							</td>
							<td class="text-center" style="width:160px;">
								<span class="effect-time">
								{if empty($item['usedtime']) && $item['endtime'] > time()}
								<span style="font-size: 12px; ">领取时间:{php echo  date('Y-m-d H:i:s',$item['createtime'])}</span><br/>
								<span style="font-size: 14px;font-weight: bold;font-family: '微软雅黑';color: #04BE02;">未使用</span><br/>
								<span style="font-size: 12px; ">过期时间:{php echo  date('Y-m-d H:i:s',$item['endtime'])}</span>
								{else if empty($item['usedtime']) && $item['endtime'] < time()}
								<span style="font-size: 12px; ">领取时间:{php echo  date('Y-m-d H:i:s',$item['createtime'])}</span><br/>
								<span style="font-size: 14px;font-weight: bold;font-family: '微软雅黑';color: orangered;">已过期</span><br/>
								{else}
								<span style="font-size: 12px; ">领取时间:{php echo  date('Y-m-d H:i:s',$item['createtime'])}</span><br/>
								<span style="font-size: 15px;color: #00B7EE;" ><a couponid="{$item['id']}" class="hexiaotime" href="javascript:;">查看核销详情</a></span><br/>
								{/if}
								</span>
							</td>
							<td class="text-center" style="width:50px;">
								<div class="text-center">
									<a href="javascript:;" class="js-remove" order-id="{$item['id']}" >删除</a>
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			
		</div>
		{/loop}
		{$pager}
		<div id="de1" style="margin-top: 15px;">
			<a href="javascript:;" class="btn btn-default min-width js-batch js-delete">删除选中记录</a>
		</div>
	</div>
	
</div>
<div id="modal-module-gift" class="modal fade" tabindex="-1">
    <div class="modal-dialog" style='width: 620px;'>
        <div class="modal-content">
            <div class="modal-header">
                <button aria-hidden="true" data-dismiss="modal" onclick="asd()" class="close" type="button">×</button>
                <h3>核销详情</h3>
            </div>
            <div class="modal-body">
            	<div>剩余使用次数：<span id="lasttime">{{d.times}}</span></div>
            	<div id="xiangq"></div>
            </div>
            <div class="modal-footer" style="padding: 5px 15px;">				
				<a class="btn btn-primary js-order-remark-post" order-id="" onclick="asd()" data-dismiss="modal" aria-hidden="true">确定</a>			
			</div>	
        </div>
    </div>
</div>
<script type="text/javascript">
	require(['jquery', 'util'], function($, util){
		$('.js-copy').each(function(){
			var id=$(this).attr('data-id');
			util.clip($("#js-copy"+id), $(this).attr('data-url'));
		});
	});
	$('.hexiaotime').click(function(){
		popwin = $('#modal-module-gift').modal();
		var id = $(this).attr('couponid');
		$.post("{php echo web_url('wlcoupon/couponlist/hexiaotime')}",{id:id},function(d){
			if(!d.errno){
				$('#xiangq').html('');
				$('#lasttime').text(d.times);
				var len = d.data.length;
				if (len == 1) {
					var html = "<div>核销时间："+d.data[0]+"</div>";
					$("#xiangq").append(html);
				}else{
					for(var i=0;i<len;i++){
						var c = i+1;
						var html = "<div>第"+c+"次核销时间："+d.data[i]+"</div>";
						$("#xiangq").append(html);
					}	
				}
				
			}
		},"json");
		$('#double').hide();
	});
	function asd(){
		$('#double').show();
	}
</script>
<script type="text/javascript">
	$('#output').click(function(){
		var orderType = '{$_GPC['orderType']}';
		var status = '{$_GPC['status']}';
		var paytype = '{$_GPC['pay_type']}';
		var keywordtype = '{$_GPC['keywordtype']}';
		var keyword = '{$_GPC['keyword']}';
		var timetype = '{$_GPC['timetype']}';
		var times = "{$_GPC['time']['start']}";
		var timee = "{$_GPC['time']['end']}";
		location.href = "{php echo web_url('order/order/output')}&orderType="+orderType+"&status="+status+"&paytype="+paytype+"&keywordtype="+keywordtype+"&keyword="+keyword+"&timetype="+timetype+"&times="+times+"&timee="+timee;
	});
	$(function(){
		$('[name="rank_all"]').click(function() {
			var checked = this.checked;
			$('.js-rank').find('input:checkbox').each(function() {
				this.checked = checked;
			});
		});
		$('#export').click(function() {
			if ($('[name="selecttime[start]"]').val() == '') {
				alert('请选择下单时间');
				$(this).focus();
				return false;
			};
			$(this).attr('type', 'submit').submit();
		});
		
		$('.order-rank').each(function(){
			o.rank(this);
		});
		
		$(".oscrollLoading").scrollLoading();
		var $pop = null;
		$('.goods-info').hover(function() {
			var obj = this;
			var img = $(this).find('img').attr('src');
			var $pop = util.popover(obj, function($popover, obj) {
				obj.$popover = $popover;
			}, '<div><img src="'+ img+'" style="max-width:200px; max-height:200px;"></div>');
		}, function() {
			this.$popover.remove();
		});

	

		
		// 编辑
		$('.js-order-edit-remark').click(function(){
			
		});
		
		// 修改价格
		$('.js-order-edit-payment').click(function() {
			var $this = $(this);
			var order_id = $this.attr('order-id');
			
			o.editPayment(order_id, function(order) {
				$this.parent()
					.find('.js-order-payment').find('.js-fee').html(order.payment).end().end()
					.find('.js-order-post-fee').find('.js-fee').html(order.post_fee);
				
				var adjust_fee = parseFloat(order.adjust_fee);
				if (adjust_fee){
					var title = adjust_fee > 0 ? '加价' : '减价';
					console.log(title);
					$this.parent()
						.find('.js-order-adjust-fee').show()
						.find('.js-title').text(title).end()
						.find('.js-fee').text(adjust_fee.toFixed(2));
				} else {
					$this.parent()
						.find('.js-order-adjust-fee').hide()
						.find('.js-title').text('').end()
						.find('.js-fee').text('');
				}
			});
		});
		$('.js-bdelete').click(function(e) {
			e.stopPropagation();
			var _this = $(this).parent().parent().parent().parent().parent().parent();
			var order_id = $(this).attr('order-id');
			util.nailConfirm(this, function(state) {
				if(!state) return;
				$.post("{php echo web_url('order/order/confirmHexiao')}",{id:order_id},function(d){
				if(!d.errno){
					_this.remove();
					util.tips(d.message, 2000);
				}
			},"json");
			}, {html: '确认核销?'});
			
		});
		$('.order-list').delegate('.js-order-cancel', 'click', function(){
			var $this = $(this);
			var order_id = $this.attr('order-id');
			o.adminClose(order_id, function(order){
				console.log(order);
				$this.parent().parent().find('.status-text').text(order.status_text).data('title', order.status_content + '<br/>关闭原因:' + order.cancel_reason);
				$this.remove();
			});
		});
		
		//发货
		$('.order-list').delegate('.js-order-send', 'click', function(){
			var $this = $(this);
			var order_id = $this.attr('order-id');
			o.send(order_id, function(order) {
				$this.parent().parent()
					.append($('<p class="express b">物流信息</p>').data('express', order.express_company).data('express-no', order.express_no))
					.find('.status-text').text(order.status_text).data('title', order.status_content);
				$this.remove();
			});
		});
		
		//删除
		$('.order-list').delegate('.js-remove', 'click', function(e){
			e.stopPropagation();
			var $this = $(this);
			var id = $this.attr('order-id');
			util.nailConfirm(this, function(state) {
				if(!state) return;
				$.post("{php echo web_url('wlcoupon/couponlist/deleteCoupon')}", { id : id }, function(data){
					if(!data.errno){
					$this.parent().parent().parent().remove();
					util.tips("删除成功！");
					};
				}, 'json');
			}, {html: '确认删除?'});
		});
		$('#de1').delegate('.js-delete','click',function(e){
			e.stopPropagation();
			var order_ids = [];
			var $checks=$('.checkbox:checkbox:checked');
			$checks.each(function() {
				if (this.checked) {
					order_ids.push(this.value);
				};
			});
				var $this = $(this);
				var ids = order_ids;
			//	alert(ids);
				util.nailConfirm(this, function(state) {
				if(!state) return;
					$.post("{php echo web_url('wlcoupon/couponlist/deleteCoupon')}", { ids : ids }, function(data){
						if(!data.errno){
						util.tips("删除成功！");
						location.reload();
						};
					}, 'json');
				}, {html: '确认删除?'});
			});
		});
		
$(document).ready(function(){
	$('#box1').attr("style",'');
})


$('#sel_parent').click(function(){
	if(this.value==3){
		$('.daterange-date').show();
		$('#sel_child').hide();
		$("#sel_child").removeAttr("style");
		$('#sel_child').attr("display","none");
		$('#sel_child').addClass('hide1');
		$('.nickname').hide();
	}
	else if(this.value==4){
		$('.daterange-date').hide();
		$('#sel_child').hide();
		$(".nickname").removeAttr("style");
		$('.nickname').show();
	}
	else if(this.value==5){
		$('.daterange-date').hide();
		$('#sel_child').hide();
		$(".nickname").removeAttr("style");
		$('.nickname').show();
	}
	else{
		$('.daterange-date').hide();
		$('.nickname').hide();
		$('#sel_child').show();
		$('#sel_child').attr("display","block");
	}
});

$(function(){
	if($('#sel_parent').val() ==3){
		$('.daterange-date').show();
		$('#sel_child').hide();
		$('.nickname').hide();
	}else if($('#sel_parent').val() == 4){
		$('.daterange-date').hide();
		$('#sel_child').hide();
		$('.nickname').show();
	}else if($('#sel_parent').val() == 5){
		$('.daterange-date').hide();
		$('#sel_child').hide();
		$('.nickname').show();
	}else{
		$('.daterange-date').hide();
		$('.nickname').hide();
		$('#sel_child').show();
	}
});




</script>

{php include wl_template('common/footer');}