{php include wl_template('common/header');}
<div class="main">
	<form action="" method="post" class="form-horizontal form layui-form" id="commentForm">
		<div class="tab-content">
			<div class="tab-pane  active" id="tab_rush">
				<div class="panel panel-default">
	<div class="panel-heading">五折信息</div>
	<div class="panel-body">
		
        <div class="form-group">
            <label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">选择商户</label>
            <div class="col-md-6">
                <div class='input-group'>
                    <div class="input-group ">
                        <input type="text" class="form-control col-md-6" id="namemerchant" name="" value="{$halfcard['storename']}" style="width: 460px;">
                        <input type="hidden" value="1" id="inspectflag" />
                        <input type="hidden" value="{$halfcard['merchantid']}" id="firstid" />
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button" onclick="popwin = $('#modal-module-merchant').modal();">选择商家</button></span>
                    </div>
                    <div class="input-group " style="margin-top:.5em;">
                        <input type="hidden" value="{$halfcard['merchantid']}" name="halfcard[merchantid]" id="sidmerchant">
                        <img src="{if empty($halfcard['logo'])}../web/resource/images/nopic.jpg{else}{php echo tomedia($halfcard['logo'])}{/if}" class="img-responsive img-thumbnail" width="150" id="imgmerchant" />
                        <em class="close" style="position:absolute; top: 0px; right: -14px;" title="删除" onclick="remove_merchant(this)">×</em></div>
                </div>
            </div>
        </div>
        <div class="form-group"  style="display: block;">
			<label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">活动名称</label>
			<div class="col-md-9 col-sm-9">
				<div class="input-group col-md-7 col-sm-7">
					<input type="text" name="halfcard[title]" class="form-control" value="{$halfcard['title']}" placeholder="填写活动名称，默认与商户名称相同" id="storetitle" />
				</div>
			</div>
		</div>
        <!---->
		 <div class="form-group">
		    <label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label layui-form-label">请选择时间方式</label>
		    <div class="layui-input-block" style="position: relative;left: 10px;">
		      	<div style="display: inline;" id="wk"><input type="radio" name="datestatus" value="1" title="按星期" {if $halfcard['datestatus'] == 1 || empty($halfcard) } checked {/if} ></div>
		      	<div style="display: inline;" id="dd"><input type="radio" name="datestatus" value="2" title="按日期" {if $halfcard['datestatus'] == 2 } checked {/if}></div>
		    </div>
		  </div>
		  <script>
		  	$('#wk').click(function(){
		  		$('#weeke').show();
		  		$('#daily').hide();
		  	});
		  	$('#dd').click(function(){
		  		$('#weeke').hide();
		  		$('#daily').show();
		  	});
		  </script>
		<div class="form-group layui-form-item" {if $halfcard['datestatus'] == 2} style="display: none;"{/if} id="weeke">
			<label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">按星期</label>
			<div class="col-md-9">
				<div class="layui-input-block">
				{if $halfcard}
						<input type="checkbox" name="halfcard[week][]" value="1" title="星期一" id="wk1">
						<input type="checkbox" name="halfcard[week][]" value="2" title="星期二" id="wk2">
						<input type="checkbox" name="halfcard[week][]" value="3" title="星期三" id="wk3"> 
						<input type="checkbox" name="halfcard[week][]" value="4" title="星期四" id="wk4"> 
						<input type="checkbox" name="halfcard[week][]" value="5" title="星期五" id="wk5"> 
						<input type="checkbox" name="halfcard[week][]" value="6" title="星期六" id="wk6"> 
						<input type="checkbox" name="halfcard[week][]" value="7" title="星期日" id="wk7">
					{loop $halfcard['week'] $week}
					<script type="text/javascript">
						if({php echo $week}==1){
							$('#wk1').attr('checked','true');
						}
						if({php echo $week}==2){
							$('#wk2').attr('checked','true');
						}
						if({php echo $week}==3){
							$('#wk3').attr('checked','true');
						}
						if({php echo $week}==4){
							$('#wk4').attr('checked','true');
						}
						if({php echo $week}==5){
							$('#wk5').attr('checked','true');
						}
						if({php echo $week}==6){
							$('#wk6').attr('checked','true');
						}
						if({php echo $week}==7){
							$('#wk7').attr('checked','true');
						}
						
					</script>
				{/loop}
			{else}
			      <input type="checkbox" name="halfcard[week][]" value="1" title="星期一">
			      <input type="checkbox" name="halfcard[week][]" value="2" title="星期二">
			      <input type="checkbox" name="halfcard[week][]" value="3" title="星期三">
			      <input type="checkbox" name="halfcard[week][]" value="4" title="星期四">
			      <input type="checkbox" name="halfcard[week][]" value="5" title="星期五">
			      <input type="checkbox" name="halfcard[week][]" value="6" title="星期六">
			      <input type="checkbox" name="halfcard[week][]" value="7" title="星期日">
			      {/if}
			    </div>
			</div>
		</div>
		<!---->
		<div class="form-group layui-form-item" {if $halfcard['datestatus'] == 1 || empty($halfcard) } style="display: none;"{/if} id="daily">
			<label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">按天数</label>
			<div class="col-md-9">
				<div class="layui-input-block">
				{if $halfcard['datestatus'] == 2}
					<?php
						for ($i=1;$i<32;$i++ ) {
							if(in_array($i,$halfcard['day'])){
								?>
								<input type="checkbox" name="halfcard[day][]" value="{php echo $i}" checked title="{php echo $i}">
						<?php	
						}else{
						?>	
					   			<input type="checkbox" name="halfcard[day][]" value="{php echo $i}" title="{php echo $i}">
	    			  <?php
						}}
					  ?>
				{else}
			      <?php
					for ($i=1;$i<32;$i++ ) {
				  ?>
    					<input type="checkbox" name="halfcard[day][]" value="{php echo $i}" title="{php echo $i}">
    			  <?php
					}
				  ?>
				{/if}		
			    </div>
			</div>
		</div>
		<!---->
		<div class="form-group"  style="display: block;">
			<label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">平日折扣</label>
			<div style="position: relative;left: 15px;top: -3px;display: inline;" onclick="asd()" class="layui-input-block">
		      <input type="checkbox" name="halfcard[daily]"  lay-skin="switch" {if $halfcard['daily'] == 1 } checked {/if}>
		      <input type="hidden" id="dailyflag" {if $halfcard['daily'] == 1 } value="1" {else} value="0" {/if} />
		    </div>
		</div>
		<div class="form-group" id="discount"  style="display: block;">
			<label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">折扣额度</label>
		    <div class="input-group col-sm-5 col-md-5 col-lg-4" style="position: relative;left: 15px;">
				<input type="tel" placeholder="请输入数字,保留一位小数" class="form-control" name="halfcard[discount]" value="{$halfcard[discount]}"/>
				<span class="input-group-addon">折</span>
			</div>
		</div>
		<div class="form-group"  style="display: block;">
			<label class="col-xs-12 col-sm-3 col-md-2 col-lg-2 control-label">使用限制</label>
			<div class="col-md-9 col-sm-9">
				<div class="input-group col-md-7 col-sm-7">
					<input type="text" name="halfcard[limit]" class="form-control" value="{$halfcard['limit']}" placeholder="如：300元以内；酒水饮料除外；两人同行一人免单；" id="use_limit" />
				</div>
			</div>
		</div>
		<div class="form-group">
		    <label class="col-xs-12 col-sm-3 col-md-2 control-label">幻灯片</label>
		    <div class="col-sm-9">
		        {php echo tpl_form_field_multi_image('halfcard[adv]',$halfcard['adv']);}
		        <span class="help-block">商品详情幻灯片，建议640X300</span>
		    </div>
		</div>
		<div class="form-group">
			<label class="col-xs-12 col-sm-3 col-md-2 control-label">商品详情</label>
			<div class="col-sm-9 col-xs-12">
				{php echo tpl_ueditor('halfcard[detail]', $halfcard['detail']);}
			</div>
		</div>
		<div class="form-group">
			<label class="col-xs-12 col-sm-3 col-md-2 control-label">使用说明</label>
			<div class="col-sm-9 col-xs-12">
				<textarea placeholder="五折卡详细的使用说明；" name="halfcard[describe]" class="form-control" cols="70">{$halfcard['describe']}</textarea>
			</div>
		</div>
		<div class="form-group layui-form-item">
		    <label class="col-xs-12 col-sm-3 col-md-2 control-label layui-form-label">状态</label>
		    <div style="position: relative;left: 15px;top: -3px;" class="layui-input-block">
		      <input type="checkbox" name="halfcard[status]" lay-skin="switch" {if $halfcard['status'] == 1 || empty($halfcard) } checked {/if}>
		    </div>
	  	</div>
	</div>
</div>
		<div id="modal-module-merchant" class="modal fade" tabindex="-1">
			<div class="modal-dialog" style='width: 920px;'>
				<div class="modal-content">
					<div class="modal-header">
						<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
						<h3>选取</h3></div>
					<div class="modal-body">
						<div class="row">
							<div class="input-group">
								<input type="text" class="form-control" name="keyword" value="" id="search-kwd-merchant" placeholder="请输入商家名称，不输入任何内容搜索结果为所有商家。" />
								<span class='input-group-btn'><button type="button" class="btn btn-default" onclick="search_merchant();">搜索</button></span>
							</div>
						</div>
						<div id="module-merchant" style="padding-top:5px;"></div>
					</div>
					<div class="modal-footer"><a href="#" class="btn btn-default" data-dismiss="modal" aria-hidden="true">关闭</a></div>
				</div>
			</div>
		</div>
	</div>
</div>
		<div class="form-group col-sm-12">
			<input type="submit" name="submit" value="提交" class="btn btn-primary col-lg-1" />
			<input type="hidden" name="token" value="{$_W['token']}" />
		</div>
	</form>
</div>
<script>
$(function () {
	window.optionchanged = false;
	$('#myTab a').click(function (e) {
		e.preventDefault();//阻止a链接的跳转行为
		$(this).tab('show');//显示当前选中的链接及关联的content
	});
	var dailyflag = $('#dailyflag').val();
	//alert(dailyflag);
	if(dailyflag == 0){
		$('#discount').hide();
	}else{
		$('#discount').show();
	}
});
</script>
<script language='javascript'>
	$('#commentForm').submit(function(){
		if($('#namemerchant').val() == '') {
	    	util.tips("请选择商户");
			return false;
		}
		if($('#storetitle').val() == '') {
	    	util.tips("请填写活动名称");
			return false;
		}
		var timetype = $(':radio[name="datestatus"]:checked').val();
		if (timetype == 1) {
			var time = $(':checkbox[name="halfcard[week][]"]:checked').val();
			if(!time) {
		    	util.tips("请选择每周五折活动时间");
				return false;
			}
		}else{
			var time = $(':checkbox[name="halfcard[day][]"]:checked').val();
			if(!time) {
		    	util.tips("请选择每月五折活动时间");
				return false;
			}
		}
		if(!$.trim($(':input[name="halfcard[limit]"]').val())){
			util.tips("请填写使用限制，无限制请填无");
			return false;
		}
		if ($('#dailyflag').val()){
			var x = $.trim($(':input[name="halfcard[discount]"]').val());
			if (isNaN(x)){
				util.tips("请填写规范的平日折扣额度");
				return false;
			}
		}
//		if(!$.trim($(':input[name="halfcard[adv]"]').val())){
//			util.tips("请至少选择一张幻灯片");
//			return false;
//		}
		if(!$.trim($(':input[name="halfcard[detail]"]').val())){
			util.tips("请填写商品详情");
			return false;
		}
		if(!$.trim($(':input[name="halfcard[describe]"]').val())){
			util.tips("请填写使用说明");
			return false;
		}
		if ($('#inspectflag').val() == 2){
			util.tips("所选商户已有五折活动");
			return false;
		}
		
		return true;
	});
	
	function inspect(){
		var merchantid = $('#sidmerchant').val();
		$.post("{php echo web_url('halfcard/halfcard_web/inspect')}", { id : merchantid }, function(data){
			if(data.errno){
				util.tips("该商户已有五折活动");
				$('#inspectflag').val(2);
			}else{
				$('#inspectflag').val(1);
				$('#storetitle').val($('#namemerchant').val());
				util.tips("操作成功");
			}
		}, 'json');
	}

	function search_merchant() {
			$("#module-merchant").html("正在搜索....")
			$.get("{php echo web_url('halfcard/halfcard_web/selectMerchant')}", {
				keyword: $.trim($('#search-kwd-merchant').val())
			}, function(dat){
				$('#module-merchant').html(dat);
			});
		}
	function remove_merchant(obj){
        $('#goodsidmerchant').val('');
        $('#namemerchant').val('');
        $('#imgmerchant').attr("src",'');
        $('#sidmerchant').val('');
       }
	function select_merchant(o) {
		var lastid = $('#sidmerchant').val();
		var fristid = $('#firstid').val();
		if (lastid != o.id) {
			$('#sidmerchant').val(o.id);
        	$('#namemerchant').val(o.storename);
        	$('#imgmerchant').attr("src",o.logo);
	    	$('#modal-module-merchant').modal('hide');
	    	if(fristid != o.id){
	    		inspect();
	    	}
		}else{
	    	$('#modal-module-merchant').modal('hide');
		}
 	}
	function asd(){
		var dailyflag = $('#dailyflag').val();
		if (dailyflag == 0) {
			$('#discount').show();
			$('#dailyflag').val(1);
		}else{
			$('#discount').hide();
			$('#dailyflag').val(0);
		}
	}
	
</script>
{php include wl_template('common/footer');}